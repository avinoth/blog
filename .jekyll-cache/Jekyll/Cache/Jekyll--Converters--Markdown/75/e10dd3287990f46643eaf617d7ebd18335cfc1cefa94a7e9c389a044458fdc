I"Ã<p>Today I would like to talk about Materialized views (henceforth referred as matviews) and how to add it to an Rails app.</p>

<h3 id="what-is-matviews">What is Matviews?</h3>

<p>From wikipedia,</p>

<blockquote>
  <p>A materialized view is a database object that contains the results of a query.</p>
</blockquote>

<p>Basically, matviews are similar to database views except they are stored in disk and updated periodically. Matviews stores the result of an query into a table like structure of its own, from which the data can be queried on. We canâ€™t add or delete rows from it but rest it behaves as an actual table.</p>

<!-- more -->

<p>Also, when the data the matviews is created upon changes the matviews need to be refreshed before being available.</p>

<p>At the time of this writing, matviews is natively available in <a href="http://docs.oracle.com/cd/B10501_01/server.920/a96567/repmview.htm">Oracle DB</a>, <a href="http://www.postgresql.org/docs/9.3/static/rules-materializedviews.html">PostgreSQL</a>, <a href="http://infocenter.sybase.com/help/index.jsp?topic=/com.sybase.infocenter.dc00269.1571/doc/html/bde1279401694270.html">Sybase</a>, <a href="http://www.ibm.com/developerworks/data/library/techarticle/dm-0509melnyk/">IBM DB2</a>, <a href="https://msdn.microsoft.com/library/ms191432.aspx">Microsoft SQL Server</a>. MySQL doesnâ€™t provide native support for matviews unfortunately, but there are open source alternatives to it.</p>

<h4 id="matviews-in-postgresql">Matviews in PostgreSQL</h4>

<p>Matviews was <a href="http://wiki.postgresql.org/wiki/Materialized_Views">introduced</a> in postgres version 9.3, and in version 9.4 they introduced an option to refresh the data concurrently.</p>

<p>The syntax for creating a matview in postgres in uncannily similar to how youâ€™ll create a table.</p>

<p><code class="highlighter-rouge">CREATE MATERIALIZED VIEW ex_matview AS SELECT col1, col2 FROM mytable WHERE col3 = condition;</code></p>

<p>Enough intro, letâ€™s get started on how to add an matview to an existing rails app.</p>

<h3 id="matviews-in-rails">Matviews in Rails</h3>
<p>For our simpler example, letâ€™s take we have a table called <code class="highlighter-rouge">sales</code> that has the inventory of all the items sold on our website with 2M+ rows on it and in the following schema,</p>

<table>
  <tr>
    <th>id<br /></th>
    <th>item</th>
    <th>price</th>
    <th>sold_date</th>
    <th>order_code</th>
  </tr>
  <tr>
    <td>1</td>
    <td>Book<br /></td>
    <td>23</td>
    <td>2015-06-01 17:06:29 UTC</td>
    <td>AVK21YO</td>
  </tr>
  <tr>
    <td>2</td>
    <td>Guitar</td>
    <td>136<br /></td>
    <td>2015-03-23 13:12:03 UTC</td>
    <td>BJ24GTS</td>
  </tr>
</table>

<p>And, we are regularly performing a query for our admin site to show how much books accounted for sale every day. We can use the below query for it</p>

<p><code class="highlighter-rouge">Sale.where(item: 'Book').group_by('DATE TRUNC('day', sold_date)').sum(:price)</code></p>

<p>Now, this is an expensive query though you add indexes to it. It is a good candidate for a matview. Start by adding a migration.</p>

<p><code class="highlighter-rouge">rails g migration AddMatViewsToSale</code></p>

<p>and add below lines to your migration file,</p>

<script src="https://gist.github.com/avinoth/a0b77f2970e230b5f7d4.js"></script>

<p>now, <code class="highlighter-rouge">bin/rake db:migrate</code> and voila! the matviews are created. Now, it wonâ€™t be available on schema file since itâ€™s not a table.</p>

<h4 id="creating-a-model">Creating a Model</h4>
<p>One awesome thing by using matviews with Rails is we can create Models for it. Now, that the matviews are created we can create a model, <code class="highlighter-rouge">SalesMatview</code> in our case.</p>

<p>Set the table name as <code class="highlighter-rouge">sales_matview</code> using <code class="highlighter-rouge">self.table_name</code> and set the model to readonly by adding the below method to it,</p>

<p><code class="highlighter-rouge">def readonly?
  true
end</code></p>

<p>and a <code class="highlighter-rouge">self.refresh</code> method with below line in it.</p>

<p><code class="highlighter-rouge">ActiveRecord::Base.connection.execute(â€˜REFRESH MATERIALIZED VIEW sales_matviewâ€™)</code></p>

<p>Weâ€™re all set to use the matview weâ€™ve just created. You can query from it like how youâ€™ll do on a normal ActiveRecord query. Now, our previous query would become like</p>

<p><code class="highlighter-rouge">SalesMatview.where(item: 'Book').select(:date, :amount)</code></p>

<p>The queries are similar but youâ€™ll notice an big difference on how these two performs. Give it a try and see it for yourself.</p>

<p>And to refresh the matview, we can simply call the <code class="highlighter-rouge">refresh</code> method we created.</p>

<p><code class="highlighter-rouge">SalesMatview.refresh</code></p>

<p>We can add it to a rake task and schedule it to perform periodically. For the refreshes that are taking too much time there is an option in Postgres to perform them concurrently, just change the refresh code to</p>

<p><code class="highlighter-rouge">REFRESH MATERIALIZED VIEW CONCURRENTLY sales_matview</code></p>

<p>but keep in mind, a unique key will be required to perform concurrent refreshes.</p>

<p>Give it a try and let me know in comments what do you think of it. See you in next post.</p>

<p>Credits to:
http://www.postgresql.org/docs/9.4/static/rules-materializedviews.html
http://en.wikipedia.org/wiki/Materialized_view</p>

:ET